{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://joget.org/schemas/form-spec/v1.0.json",
  "title": "Joget Form Specification",
  "description": "Schema for Joget DX form definitions in canonical YAML format",
  "type": "object",
  "required": ["form", "fields"],
  "properties": {
    "form": {
      "$ref": "#/$defs/FormMetadata"
    },
    "fields": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Field"
      },
      "minItems": 1
    }
  },
  "$defs": {
    "FormMetadata": {
      "type": "object",
      "required": ["id", "name"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z][a-zA-Z0-9_]{0,19}$",
          "maxLength": 20,
          "description": "Form ID (must match tableName, max 20 chars)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 255,
          "description": "Human-readable form name displayed in Joget"
        },
        "tableName": {
          "type": "string",
          "pattern": "^[a-zA-Z][a-zA-Z0-9_]{0,19}$",
          "maxLength": 20,
          "description": "Database table name (must match id)"
        },
        "description": {
          "type": "string",
          "description": "Optional form description"
        }
      }
    },
    "Field": {
      "type": "object",
      "required": ["id", "label", "type"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z][a-zA-Z0-9_]*$",
          "maxLength": 50,
          "description": "Field ID (database column name)"
        },
        "label": {
          "type": "string",
          "minLength": 1,
          "description": "Field label shown in UI"
        },
        "type": {
          "enum": [
            "hiddenField",
            "textField",
            "passwordField",
            "textArea",
            "selectBox",
            "checkBox",
            "radio",
            "datePicker",
            "fileUpload",
            "customHTML",
            "idGenerator",
            "subform",
            "grid",
            "calculationField",
            "richTextEditor",
            "formGrid",
            "multiPagedForm",
            "section"
          ],
          "description": "Field type (Phase 1: 9 standard, Phase 2: 4 custom/advanced, Enterprise: 4 advanced, Structural: section)"
        },
        "required": {
          "type": "boolean",
          "default": false,
          "description": "Whether field is mandatory"
        },
        "readonly": {
          "type": "boolean",
          "default": false,
          "description": "Whether field is read-only"
        },
        "defaultValue": {
          "type": "string",
          "description": "Default value for field"
        },
        "placeholder": {
          "type": "string",
          "description": "Placeholder text (textField, textArea, passwordField)"
        },
        "size": {
          "enum": ["small", "medium", "large", "full"],
          "default": "medium",
          "description": "Field size (full = 100% width)"
        },
        "rows": {
          "type": "integer",
          "minimum": 1,
          "maximum": 50,
          "description": "Number of rows (textArea)"
        },
        "cols": {
          "type": "integer",
          "minimum": 1,
          "maximum": 200,
          "description": "Number of columns (textArea)"
        },
        "maxlength": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum character length"
        },
        "options": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Option"
          },
          "minItems": 1,
          "description": "Static options (selectBox, checkBox, radio)"
        },
        "optionsSource": {
          "$ref": "#/$defs/OptionsSource",
          "description": "Dynamic options configuration"
        },
        "multiple": {
          "type": "boolean",
          "default": false,
          "description": "Allow multiple selections (selectBox, checkBox)"
        },
        "dateFormat": {
          "type": "string",
          "default": "yyyy-MM-dd",
          "description": "Date format pattern (datePicker)"
        },
        "maxSize": {
          "type": "integer",
          "description": "Maximum file size in MB (fileUpload)"
        },
        "fileTypes": {
          "type": "string",
          "description": "Allowed file extensions, comma-separated (fileUpload)"
        },
        "html": {
          "type": "string",
          "description": "HTML content (customHTML)"
        },
        "prefix": {
          "type": "string",
          "description": "ID prefix (idGenerator)"
        },
        "postfix": {
          "type": "string",
          "description": "ID postfix (idGenerator)"
        },
        "format": {
          "type": "string",
          "description": "ID format pattern, e.g., '{prefix}{count:05d}{postfix}' (idGenerator)"
        },
        "formId": {
          "type": "string",
          "description": "Referenced form ID (subform)"
        },
        "columns": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/GridColumn"
          },
          "description": "Grid column definitions (grid, formGrid)"
        },
        "equation": {
          "type": "string",
          "description": "Calculation equation/formula (calculationField)"
        },
        "storeNumeric": {
          "type": "boolean",
          "default": true,
          "description": "Store result as numeric value (calculationField)"
        },
        "editor": {
          "enum": ["tinymce", "quill"],
          "default": "tinymce",
          "description": "Rich text editor type (richTextEditor)"
        },
        "allowAddRow": {
          "type": "boolean",
          "default": true,
          "description": "Allow adding new rows (formGrid)"
        },
        "allowDeleteRow": {
          "type": "boolean",
          "default": true,
          "description": "Allow deleting rows (formGrid)"
        },
        "validateMinRow": {
          "type": "integer",
          "minimum": 0,
          "description": "Minimum number of rows (grid, formGrid)"
        },
        "validateMaxRow": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum number of rows (grid, formGrid)"
        },
        "errorMessage": {
          "type": "string",
          "description": "Custom error message for grid validation (grid, formGrid)"
        },
        "pages": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Page"
          },
          "minItems": 1,
          "description": "Page definitions (multiPagedForm)"
        },
        "showNavigation": {
          "type": "boolean",
          "default": true,
          "description": "Show page navigation (multiPagedForm)"
        },
        "showProgressBar": {
          "type": "boolean",
          "default": true,
          "description": "Show progress bar (multiPagedForm)"
        },
        "validation": {
          "$ref": "#/$defs/Validation",
          "description": "Validation rules"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {"type": {"const": "selectBox"}}
          },
          "then": {
            "oneOf": [
              {"required": ["options"]},
              {"required": ["optionsSource"]}
            ]
          }
        },
        {
          "if": {
            "properties": {"type": {"enum": ["checkBox", "radio"]}}
          },
          "then": {
            "oneOf": [
              {"required": ["options"]},
              {"required": ["optionsSource"]}
            ]
          }
        }
      ]
    },
    "Option": {
      "type": "object",
      "required": ["value", "label"],
      "properties": {
        "value": {
          "type": "string",
          "description": "Option value (stored in database)"
        },
        "label": {
          "type": "string",
          "description": "Option label (displayed to user)"
        }
      }
    },
    "OptionsSource": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "enum": ["formData", "api", "database"],
          "description": "Options source type"
        },
        "formId": {
          "type": "string",
          "description": "Source form ID (formData type)"
        },
        "valueColumn": {
          "type": "string",
          "description": "Column for option value (formData, database). Use 'code' for MDM forms or the specific code field (e.g., 'campaignCode') for transactional forms. NEVER use 'id'."
        },
        "labelColumn": {
          "type": "string",
          "default": "name",
          "description": "Column for option label (formData, database)"
        },
        "groupingColumn": {
          "type": "string",
          "description": "Column for option grouping"
        },
        "parentField": {
          "type": "string",
          "description": "Parent field ID for cascading dropdown"
        },
        "filterField": {
          "type": "string",
          "description": "Field to filter by in cascading dropdown"
        },
        "addEmptyOption": {
          "type": "boolean",
          "default": true,
          "description": "Add empty first option (formData, api)"
        },
        "emptyLabel": {
          "type": "string",
          "default": "",
          "description": "Label for empty option"
        },
        "useAjax": {
          "type": "boolean",
          "default": false,
          "description": "Use AJAX for loading options"
        },
        "jsonUrl": {
          "type": "string",
          "format": "uri",
          "description": "API endpoint URL (api type)"
        },
        "requestType": {
          "enum": ["GET", "POST", "PUT", "DELETE"],
          "default": "GET",
          "description": "HTTP request method (api type)"
        },
        "postMethod": {
          "enum": ["parameters", "jsonPayload", "custom"],
          "default": "parameters",
          "description": "POST/PUT body format (api type)"
        },
        "params": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {"type": "string"},
              "value": {"type": "string"}
            }
          },
          "description": "Request parameters (api type)"
        },
        "customPayload": {
          "type": "string",
          "description": "Custom JSON payload (api type, postMethod=custom)"
        },
        "headers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {"type": "string"},
              "value": {"type": "string"}
            }
          },
          "description": "HTTP headers (api type)"
        },
        "idColumn": {
          "type": "string",
          "description": "JSON field for value (api type)"
        },
        "multirowBaseObject": {
          "type": "string",
          "description": "Base JSON object path for array extraction (api type)"
        },
        "jdbcDatasource": {
          "type": "string",
          "default": "default",
          "description": "JDBC datasource name (database type)"
        },
        "tableName": {
          "type": "string",
          "description": "Database table name (database type)"
        },
        "extraCondition": {
          "type": "string",
          "description": "SQL WHERE condition (database type)"
        },
        "addEmpty": {
          "type": "boolean",
          "default": true,
          "description": "Add empty first option (database type)"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {"type": {"const": "formData"}}
          },
          "then": {
            "required": ["formId"]
          }
        },
        {
          "if": {
            "properties": {"type": {"const": "api"}}
          },
          "then": {
            "required": ["jsonUrl", "idColumn", "labelColumn"]
          }
        },
        {
          "if": {
            "properties": {"type": {"const": "database"}}
          },
          "then": {
            "required": ["tableName", "valueColumn", "labelColumn"]
          }
        }
      ]
    },
    "Validation": {
      "type": "object",
      "properties": {
        "pattern": {
          "type": "string",
          "description": "Regex pattern for validation"
        },
        "minLength": {
          "type": "integer",
          "minimum": 0,
          "description": "Minimum character length"
        },
        "maxLength": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum character length"
        },
        "message": {
          "type": "string",
          "description": "Custom validation error message"
        }
      }
    },
    "GridColumn": {
      "type": "object",
      "required": ["value", "label"],
      "properties": {
        "value": {
          "type": "string",
          "description": "Field ID from child form to display in column"
        },
        "label": {
          "type": "string",
          "description": "Column header label"
        },
        "formatType": {
          "type": "string",
          "enum": ["text", "options", "date"],
          "default": "text",
          "description": "Column display format type"
        },
        "format": {
          "type": "string",
          "default": "",
          "description": "Format pattern (for date columns)"
        },
        "width": {
          "type": "string",
          "default": "",
          "description": "Column width (e.g., '100px', '20%')"
        }
      }
    },
    "Page": {
      "type": "object",
      "required": ["formId"],
      "properties": {
        "formId": {
          "type": "string",
          "description": "Referenced form ID for this page"
        },
        "label": {
          "type": "string",
          "description": "Page label/title"
        },
        "description": {
          "type": "string",
          "description": "Page description"
        }
      }
    }
  }
}
